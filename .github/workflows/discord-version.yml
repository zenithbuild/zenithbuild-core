name: Discord Release Notifications

on:
  release:
    types: [published, edited, prereleased, released]

# Security: Limit permissions to only what's needed
permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Release Notification to Discord
        env:
          DISCORD_VERSION_WEBHOOK_URL: ${{ secrets.DISCORD_VERSION_WEBHOOK_URL }}
        run: |
          set -e  # Exit on error
          set +x  # Don't echo commands (prevents secret exposure in logs)
          
          # Mask the webhook URL in logs to prevent accidental exposure
          echo "::add-mask::$DISCORD_VERSION_WEBHOOK_URL"
          
          # Validate secret is set
          if [ -z "$DISCORD_VERSION_WEBHOOK_URL" ]; then
            echo "‚ùå DISCORD_VERSION_WEBHOOK_URL secret is not set"
            exit 1
          fi
          
          # Validate webhook URL format for security
          if [[ ! "$DISCORD_VERSION_WEBHOOK_URL" =~ ^https://discord\.com/api/webhooks/[0-9]+/[A-Za-z0-9_-]+$ ]]; then
            echo "‚ùå Invalid Discord webhook URL format"
            exit 1
          fi
          
          # Get release information
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_BODY="${{ github.event.release.body }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          RELEASE_AUTHOR="${{ github.event.release.author.login }}"
          RELEASE_PRERELEASE="${{ github.event.release.prerelease }}"
          RELEASE_ACTION="${{ github.event.action }}"
          
          REPO="${{ github.repository }}"
          
          # Determine release type and formatting
          if [ "$RELEASE_PRERELEASE" = "true" ]; then
            COLOR="15105570"  # Orange
            EMOJI="üß™"
            TITLE="Pre-Release Published"
          else
            # Parse version to determine type
            VERSION_TYPE=$(node <<VERSION_SCRIPT
            const tag = '$RELEASE_TAG';
            // Remove 'v' prefix if present
            const version = tag.replace(/^v/i, '');
            const parts = version.split('.').map(function(p) { return parseInt(p) || 0; });
            
            if (parts[0] > 0 && parts[1] === 0 && parts[2] === 0) {
              console.log('major');
            } else if (parts[1] > 0 && parts[2] === 0) {
              console.log('minor');
            } else {
              console.log('patch');
            }
            VERSION_SCRIPT
            )
            
            case "$VERSION_TYPE" in
              major)
                COLOR="15158332"  # Red
                EMOJI="üöÄ"
                TITLE="Major Release"
                ;;
              minor)
                COLOR="3066993"  # Green
                EMOJI="‚ú®"
                TITLE="Minor Release"
                ;;
              patch)
                COLOR="3447003"  # Blue
                EMOJI="üîß"
                TITLE="Patch Release"
                ;;
              *)
                COLOR="3447003"  # Blue
                EMOJI="üì¶"
                TITLE="Release Published"
                ;;
            esac
          fi
          
          # Handle different release actions
          case "$RELEASE_ACTION" in
            published)
              # Already set above
              ;;
            edited)
              COLOR="15844367"  # Gold
              EMOJI="‚úèÔ∏è"
              TITLE="Release Edited"
              ;;
            prereleased)
              COLOR="15105570"  # Orange
              EMOJI="üß™"
              TITLE="Pre-Release Published"
              ;;
            released)
              # Use version-based formatting
              ;;
          esac
          
          # Export variables for Node.js script
          export EMOJI TITLE COLOR
          
          # Use Node.js to properly build JSON payload with escaping
          cat > /tmp/discord_version_payload.js <<JS_EOF
          const repo = "$REPO";
          const emoji = process.env.EMOJI || 'üì¶';
          const title = process.env.TITLE || 'Release Published';
          const color = parseInt(process.env.COLOR || '3447003', 10);
          const releaseTag = '$RELEASE_TAG';
          const releaseName = '$RELEASE_NAME';
          const releaseBody = '$RELEASE_BODY';
          const releaseUrl = '$RELEASE_URL';
          const releaseAuthor = '$RELEASE_AUTHOR';
          const isPrerelease = '$RELEASE_PRERELEASE' === 'true';
          
          // Truncate release body if too long
          let body = releaseBody || '*No release notes*';
          if (body.length > 1000) {
            body = body.substring(0, 1000) + '...';
          }
          
          // Build embed
          const embed = {
            title: emoji + ' ' + title,
            description: '**' + (releaseName || releaseTag) + '**' + (isPrerelease ? ' (Pre-release)' : ''),
            url: releaseUrl,
            color: color,
            fields: [
              {
                name: 'Tag',
                value: String.fromCharCode(96) + releaseTag + String.fromCharCode(96),
                inline: true
              },
              {
                name: 'Type',
                value: isPrerelease ? 'Pre-release' : 'Release',
                inline: true
              }
            ],
            footer: {
              text: repo + ' ‚Ä¢ ' + releaseAuthor
            },
            timestamp: new Date().toISOString()
          };
          
          // Add release notes if available
          if (body && body !== '*No release notes*') {
            embed.fields.push({
              name: 'Release Notes',
              value: body,
              inline: false
            });
          }
          
          console.log(JSON.stringify({ embeds: [embed] }));
          JS_EOF
          
          # Run the Node.js script
          PAYLOAD=$(node /tmp/discord_version_payload.js)
          
          # Send to Discord with error handling
          HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -X POST "$DISCORD_VERSION_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          
          # Check response
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Successfully sent version update notification to Discord"
          else
            echo "‚ùå Failed to send notification (HTTP $HTTP_CODE)"
            if [ -f /tmp/discord_response.txt ]; then
              echo "Response: $(cat /tmp/discord_response.txt)"
            fi
            exit 1
          fi
          
          # Clean up
          rm -f /tmp/discord_response.txt /tmp/discord_version_payload.js

